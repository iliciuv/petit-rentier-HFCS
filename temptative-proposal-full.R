### WORKSPACE SETUP- MEMORY CLEAN AND PACKAGES IMPORT
`%>%` <- magrittr::`%>%` # nolint
options(scipen = 99)
rif_var <- "gini"
c("survey", "data.table", "dineq", "xgboost") %>% sapply(library, character.only = T)
selected_variables <- c(
    "facine3", "renthog", "renthog1", "bage", "homeowner", "worker", "young", "sex", "class",
    "actreales", "riquezanet", "riquezafin", "educ", "auton", "class",
    "tipo_auton", "direc", "multipr", "useprop", "inherit"
)
dt_eff <- "saves/eff-pool-2002-2020.csv" %>% fread() # Data table con microdatos anuales
# Convert 'class' and 'bage' to dummy variables
dt_eff[, ..selected_variables]
dt_eff[is.na(dt_eff)] <- 0
final_dt <- data.table()
models_dt <- list()

cpi <- c(73.31, 80.44, 89.11, 93.35, 96.82, 97.98, 100) / 100
years <- c(2002, 2005, 2008, 2011, 2014, 2017, 2020)
dt_eff[homeowner == "", homeowner := "Non-Owner"]
dt_eff$class <- relevel(as.factor(dt_eff$class), ref = "self-employed")
dt_eff$bage <- relevel(as.factor(dt_eff$bage), ref = "45-54")
dt_eff$inherit <- relevel(as.factor(dt_eff$inherit), ref = "Non-inherit")
dt_eff$homeowner <- relevel(as.factor(dt_eff$homeowner), ref = "Non-Owner")

aa <- fastDummies::dummy_cols(dt_eff$class)

for (i in seq_along(years)) {
    dt_transform <- dt_eff[sv_year == years[i]]
    # Estimate RIF model
    dt_transform$rif_actreales <- rif(dt_transform$actreales, method = as.character(rif_var), quantile = 0.5, weights = dt_transform$facine3)
    models_dt[[i]] <- lm(rif_actreales ~ bage + sex + educ + riquezafin + inherit + direc + homeowner + multipr, weights = facine3, data = dt_transform)
    coefs <- coef(summary(lm(rif_actreales ~ bage + sex + educ + riquezafin + inherit + direc + homeowner + multipr, weights = facine3, data = dt_transform))) %>% data.table()
    coefs[, Estimate := Estimate / cpi[i]]
    coefs <- as.data.frame(coefs)
    pre_dt <- c(rbind(coefs[, "Estimate"], coefs[, "Pr(>|t|)"]))
    final_dt <- cbind(final_dt, pre_dt)
}

interleaved_names <- c(rbind(row.names(coef(summary(models_dt[[1]]))), rep("p-val", 10)))
interleaved_names_int <- c(rbind(row.names(coef(summary(models_dt_int[[1]]))), rep("p-val", 28)))

final_dt <- cbind(interleaved_names, round(final_dt, 3))
colnames(final_dt) <- c("vars", years)

fwrite(final_dt, file = paste0("output/full-model/", rif_var, "_final_dt.csv"))

sink(paste0("output/full-model/", rif_var, "_temptative_multi.txt"))
print("################## MAIN MODEL ###################")
print(final_dt)
sink()

sink(paste0("output/full-model/", rif_var, "_temptative.txt"))

for (i in seq_along(years)) {
    print(paste0("###############", years[i], " ###############"))
    print(summary(models_dt[[i]]))
}
sink()
